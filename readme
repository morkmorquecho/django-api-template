# üõçÔ∏è Colecci√≥n Lorenza - API REST

API REST completa para e-commerce con sistema de blog integrado, construida con Django REST Framework.

## üìã Tabla de Contenidos

- [Stack Tecnol√≥gico](#-stack-tecnol√≥gico)
- [Requisitos Previos](#-requisitos-previos)
- [Instalaci√≥n](#-instalaci√≥n)
- [Configuraci√≥n](#Ô∏è-configuraci√≥n)
- [Estructura del Proyecto](#-estructura-del-proyecto)
- [Comandos √ötiles](#-comandos-√∫tiles)
- [Caracter√≠sticas Principales](#-caracter√≠sticas-principales)
- [Documentaci√≥n de la API](#-documentaci√≥n-de-la-api)
- [Deployment](#-deployment)

## üöÄ Stack Tecnol√≥gico

### Backend
- **Django** 5.2.10
- **Django REST Framework** - API REST
- **Simple JWT** - Autenticaci√≥n JWT
- **dj-rest-auth** - Endpoints de autenticaci√≥n
- **django-allauth** - Autenticaci√≥n social (Google)

### Base de Datos
- **SQL Server** (mssql-django)
- Soporte para autenticaci√≥n Windows y est√°ndar

### Documentaci√≥n y Monitoreo
- **drf-spectacular** - Documentaci√≥n Swagger/OpenAPI
- **Sentry** - Monitoreo de errores en producci√≥n
- **Rich** - Logging mejorado en consola

### Otras Herramientas
- **django-cors-headers** - Manejo de CORS
- **python-decouple** - Gesti√≥n de variables de entorno
- **Redis** (opcional) - Cache y rate limiting

## üì¶ Requisitos Previos

- Python 3.13+
- pipenv (para gesti√≥n de dependencias)
- SQL Server (o cualquier base de datos compatible)
- ODBC Driver 17 for SQL Server

### Instalar pipenv

```bash
pip install pipenv
```

## üîß Instalaci√≥n

### 1. Clonar el repositorio

```bash
git clone <url-del-repositorio>
cd template_django
```

### 2. Instalar dependencias

```bash
pipenv install
```

### 3. Activar el entorno virtual

```bash
pipenv shell
```

### 4. Configurar variables de entorno

Crea un archivo `.env` en la ra√≠z del proyecto (ver secci√≥n [Configuraci√≥n](#Ô∏è-configuraci√≥n)).

### 5. Ejecutar migraciones

```bash
pipenv run mk  # Crear migraciones
pipenv run mi  # Aplicar migraciones
```

### 6. Crear superusuario

```bash
pipenv run su
```

### 7. Ejecutar el servidor

```bash
pipenv run r
```

El servidor estar√° disponible en `http://localhost:8000`

## ‚öôÔ∏è Configuraci√≥n

### Variables de Entorno

Crea un archivo `.env` en la ra√≠z del proyecto con las siguientes variables:

```env
# ==================== CONFIGURACI√ìN GENERAL ====================
DEBUG=True
SECRET_KEY=tu-secret-key-aqui
ACTIVE_RATES=False  # True para activar rate limiting estricto
CACHES_REDIS=False  # True para usar Redis como cache

# ==================== BASE DE DATOS ====================
ENGINE_DB=mssql
NAME_DB=nombre_base_datos
HOST_DB=localhost\SQLEXPRESS
PORT_DB=1433

# Para autenticaci√≥n SQL Server est√°ndar (descomenta si no usas Windows Auth)
# USER_DB=tu_usuario
# PASSWORD_DB=tu_contrase√±a

# ==================== PAGINACI√ìN ====================
PAGINATION_LIMIT=15

# ==================== EMAIL (Gmail SMTP) ====================
EMAIL_HOST_USER=tu-email@gmail.com
EMAIL_HOST_PASSWORD=tu-app-password-aqui  # Contrase√±a de aplicaci√≥n de Gmail

# ==================== CORS ====================
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173

# ==================== AUTENTICACI√ìN SOCIAL ====================
# Google OAuth
ID_GOOGLE_CLIENT=tu-client-id.apps.googleusercontent.com
SECRET_GOOGLE_CLIENT=tu-secret-client
GOOGLE_CALLBACK=http://localhost:8000/auth/google/callback

# Facebook OAuth (opcional)
FACEBOOK_APP_ID=
FACEBOOK_APP_SECRET=

# ==================== SENTRY (Producci√≥n) ====================
SDK_SENTRY=https://tu-dsn@sentry.io/proyecto

# ==================== DOCUMENTACI√ìN SWAGGER ====================
TITLE_SWAGGER=API Colecci√≥n Lorenza
DESCRIPTION_SWAGGER=API REST para e-commerce con gesti√≥n de productos, √≥rdenes y blog
```

### Notas de Configuraci√≥n

#### Base de Datos
si usas sql server al crear migraciones tendras problemas, utiliza estos scripts:

1. Buscar las constraints de las tablas problem√°ticas:

SELECT name, OBJECT_NAME(parent_object_id) AS tabla
FROM sys.objects 
WHERE type IN ('UQ', 'PK', 'F') 
AND parent_object_id = OBJECT_ID('token_blacklist_blacklistedtoken');

SELECT name, OBJECT_NAME(parent_object_id) AS tabla
FROM sys.objects 
WHERE type IN ('UQ', 'PK', 'F') 
AND parent_object_id = OBJECT_ID('token_blacklist_outstandingtoken');

2. Eliminar las constraints que bloqueaban el ALTER:

ALTER TABLE token_blacklist_outstandingtoken 
DROP CONSTRAINT token_blacklist_outstandingtoken_jti_hex_d9bdf6f7_uniq;

ALTER TABLE token_blacklist_blacklistedtoken 
DROP CONSTRAINT UQ__token_bl__CB3C9E16F1772B81;

3. Correr las migraciones:

pipenv run python manage.py migrate

**Opci√≥n 1: Autenticaci√≥n Windows (SQL Server)**
```env
ENGINE_DB=mssql
NAME_DB=config('NAME_DB')
HOST_DB=DESKTOP-Q020TPN\SQLEXPRESS
```

**Opci√≥n 2: Autenticaci√≥n SQL Server**
Descomenta las l√≠neas en `settings.py` para usar autenticaci√≥n est√°ndar:
```python
DATABASES = {
    'default': {
        'ENGINE': config('DB_ENGINE'),
        'NAME': config('DB_NAME'),
        'USER': config('DB_USER'),
        'PASSWORD': config('DB_PASSWORD'),
        'HOST': config('DB_HOST'),
        'PORT': config('DB_PORT', cast=int),
    }
}
```

#### Email (Gmail)

Para usar Gmail necesitas generar una **contrase√±a de aplicaci√≥n**:
1. Ir a https://myaccount.google.com/security
2. Activar verificaci√≥n en 2 pasos
3. Generar contrase√±a de aplicaci√≥n
4. Usar esa contrase√±a en `EMAIL_HOST_PASSWORD`

#### Redis (Opcional)

Si quieres usar Redis para cache:
```env
CACHES_REDIS=True
REDIS_HOST=localhost
REDIS_PORT=6379
```

## üìÅ Estructura del Proyecto

```
django-template/
‚îú‚îÄ‚îÄ config/                  # Configuraci√≥n del proyecto
‚îÇ   ‚îú‚îÄ‚îÄ settings.py         # Configuraci√≥n principal
‚îÇ   ‚îú‚îÄ‚îÄ urls.py            # URLs principales
‚îÇ   ‚îú‚îÄ‚îÄ wsgi.py            # WSGI para deployment
‚îÇ   ‚îú‚îÄ‚îÄ renderers.py       # Renderizadores personalizados
‚îÇ   ‚îî‚îÄ‚îÄ throttling.py      # Rate limiting personalizado
‚îÇ
‚îú‚îÄ‚îÄ users/                  # App de usuarios
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py
‚îÇ   ‚îú‚îÄ‚îÄ views.py
‚îÇ   ‚îî‚îÄ‚îÄ urls.py
‚îÇ
‚îú‚îÄ‚îÄ blog/                   # App de blog
‚îú‚îÄ‚îÄ core/                   # Utilidades compartidas
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îî‚îÄ‚îÄ exceptions.py  # Manejo de excepciones
‚îÇ
‚îú‚îÄ‚îÄ templates/              # Templates de email
‚îú‚îÄ‚îÄ media/                  # Archivos multimedia
‚îú‚îÄ‚îÄ staticfiles/           # Archivos est√°ticos
‚îú‚îÄ‚îÄ logs/                   # Logs de la aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ django.log
‚îÇ   ‚îî‚îÄ‚îÄ errors.log
‚îÇ
‚îú‚îÄ‚îÄ Pipfile                # Dependencias
‚îú‚îÄ‚îÄ Pipfile.lock
‚îú‚îÄ‚îÄ manage.py
‚îú‚îÄ‚îÄ .env                   # Variables de entorno (no incluir en git)
‚îî‚îÄ‚îÄ README.md
```

## üéØ Comandos √ötiles

El proyecto incluye scripts de pipenv para facilitar el desarrollo:

```bash
# Servidor de desarrollo
pipenv run r

# Migraciones
pipenv run mk              # Crear migraciones
pipenv run mi              # Aplicar migraciones

# Gesti√≥n de usuarios
pipenv run su              # Crear superusuario

# Desarrollo
pipenv run sh              # Django shell
pipenv run test            # Ejecutar tests
pipenv run st <nombre>     # Crear nueva app

# Mantenimiento
pipenv run clearsessions   # Limpiar sesiones expiradas

# Comando directo de Django
pipenv run django <comando>
```

## ‚ú® Caracter√≠sticas Principales

### Autenticaci√≥n y Seguridad

- ‚úÖ **JWT (JSON Web Tokens)** con refresh tokens
- ‚úÖ **Autenticaci√≥n social** con Google OAuth
- ‚úÖ **Verificaci√≥n de email** obligatoria
- ‚úÖ **Rate limiting** configurable por endpoint
- ‚úÖ **CORS** configurado para frontend
- ‚úÖ **Blacklist de tokens** JWT

### API REST

- ‚úÖ **Paginaci√≥n autom√°tica** (15 items por defecto)
- ‚úÖ **Documentaci√≥n Swagger/OpenAPI** en `/api/schema/swagger-ui/`
- ‚úÖ **Respuestas estandarizadas** con renderer personalizado
- ‚úÖ **Manejo de excepciones** centralizado
- ‚úÖ **Throttling por usuario y endpoint**

### Logging y Monitoreo

- ‚úÖ **Logs enriquecidos** con Rich en consola
- ‚úÖ **Logs rotativos** en archivos (15MB m√°x)
- ‚úÖ **Sentry** para monitoreo en producci√≥n
- ‚úÖ **Logs separados** para errores

### Base de Datos

- ‚úÖ **SQL Server** con soporte Windows Auth
- ‚úÖ **Migraciones autom√°ticas**
- ‚úÖ **ORM de Django**

### M√≥dulos del Sistema

- **Users** - Gesti√≥n de usuarios y perfiles
- **Blog** - Sistema de publicaciones
- **Core** - Utilidades compartidas

## üìö Documentaci√≥n de la API

### Swagger UI

La documentaci√≥n interactiva de la API est√° disponible en:

```
http://localhost:8000/api/schema/swagger-ui/
```

### Endpoints Principales

#### Autenticaci√≥n

```
POST   /api/auth/register/                 # Registro de usuario
POST   /api/auth/login/                    # Login (JWT)
POST   /api/auth/logout/                   # Logout
POST   /api/auth/token/refresh/            # Refrescar token
POST   /api/auth/oauth/google/             # Login con Google
```

#### Rate Limits

Los l√≠mites de rate limiting dependen de `ACTIVE_RATES`:

**Desarrollo** (`ACTIVE_RATES=False`):
- Usuarios an√≥nimos: 9,935 req/hora
- Usuarios autenticados: 99,500 req/hora

**Producci√≥n** (`ACTIVE_RATES=True`):
- Usuarios an√≥nimos: 35 req/hora
- Usuarios autenticados: 500 req/hora
- Login: 5 req/hora
- Registro: 3 req/hora
- Endpoints sensibles: 5 req/hora
- Burst: 30 req/min

### Autenticaci√≥n

Incluye el token JWT en el header:

```
Authorization: Bearer <tu-access-token>
```

## üöÄ Deployment

### Preparaci√≥n para Producci√≥n

1. **Variables de entorno**

```env
DEBUG=False
SECRET_KEY=<genera-una-clave-segura>
ACTIVE_RATES=True
ALLOWED_HOSTS=tu-dominio.com
```

2. **Seguridad SSL**

Cuando `DEBUG=False`, se activan autom√°ticamente:
- HTTPS redirect
- HSTS
- Secure cookies

3. **Archivos est√°ticos**

```bash
python manage.py collectstatic
```

4. **Sentry**

Configura `SDK_SENTRY` con tu DSN de Sentry.

### Checklist de Deployment

- [ ] `DEBUG=False`
- [ ] `SECRET_KEY` √∫nico y seguro
- [ ] Base de datos de producci√≥n configurada
- [ ] `ALLOWED_HOSTS` configurado
- [ ] Variables de entorno seguras
- [ ] Sentry configurado
- [ ] Redis configurado (recomendado)
- [ ] Archivos est√°ticos servidos correctamente
- [ ] HTTPS configurado
- [ ] Backups de base de datos programados
- [ ] Logs monitoreados

### Servidores Recomendados

- **Web Server**: Gunicorn + Nginx
- **Base de datos**: SQL Server (Azure SQL, AWS RDS)
- **Cache**: Redis Cloud
- **Hosting**: Azure, AWS, DigitalOcean, Railway

## üìù Notas Adicionales

### Desarrollo

- El proyecto usa **Rich** para logs coloridos en desarrollo
- Los logs se guardan en `logs/django.log` y `logs/errors.log`
- El proyecto usa **pipenv** para gesti√≥n de dependencias


